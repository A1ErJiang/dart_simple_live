name: 最终通关-打包Windows版
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: 安装 Flutter 环境
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: 开启 Windows 支持
        run: flutter config --enable-windows-desktop

      - name: 安装核心库依赖
        working-directory: ./simple_live_core
        run: flutter pub get

      - name: 安装 APP 依赖
        working-directory: ./simple_live_app
        run: flutter pub get

      - name: 生成辅助代码
        working-directory: ./simple_live_app
        run: dart run build_runner build --delete-conflicting-outputs

      - name: 开始打包 (Build exe)
        working-directory: ./simple_live_app
        run: flutter build windows --release

      # --- 修改点：使用自动搜索脚本打包 ---
      - name: 自动搜索并打包
        shell: pwsh
        run: |
          # 在 build 文件夹里寻找 .exe 文件
          $exePath = Get-ChildItem -Path "simple_live_app/build/windows" -Filter "*.exe" -Recurse | Where-Object { $_.DirectoryName -like "*Release*" } | Select-Object -First 1
          
          if ($exePath) {
              Write-Host "找到程序文件: $($exePath.FullName)"
              # 进入该文件所在的目录
              Set-Location $exePath.DirectoryName
              # 打包当前目录下的所有文件到根目录的 windows_app.zip
              7z a "$env:GITHUB_WORKSPACE/windows_app.zip" .
          } else {
              Write-Error "错误：在构建目录中找不到 .exe 文件！"
          }

      - name: 上传打包结果
        uses: actions/upload-artifact@v4
        with:
          name: SimpleLive-Windows-App
          path: windows_app.zip
